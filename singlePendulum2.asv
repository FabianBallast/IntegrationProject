%%
load data/sysID/sweepv4;

t_ID = t(500:1001);
Y_ID = theta_1(1:502);
U_ID = input(2:503);

[Y_ID2, th2] = preprocessing(Y_ID, theta_2(1:502), t_ID);
Y_ID2 = Y_ID2-Y_ID(1);

figure(1);
plot(t_ID, Y_ID2)

figure(2);
plot(t_ID, th2);

data1 = iddata(Y_ID2, U_ID, 0.01, 'Name', 'Sweep');

%%
p = polyfit(t_ID,Y_ID2,23);
y1 = polyval(p,t_ID);
% y1=smooth(Y_ID2, 7);
figure(1)
plot(t_ID, Y_ID2)
hold on
plot(t_ID,y1)
hold off

%%
figure(2)
a=diff(y1, 2) / 0.01^2;
b = polyder(polyder(p));
a = [a(1); a; a(end)];
plot(t_ID, a); hold on;
plot(t_ID, polyval(b, t_ID)); hold off;

%% NLID
ddtheta1 = polyval(b, t_ID);
dtheta1 = polyval(polyder(p), t_ID);
theta1 = Y_ID2;
u_th2 = [theta1, dtheta1; ddtheta1];

z = iddata(th2,u_th2,0.01,'Name','Single Pendulum');

fileName = 'singlePend3';
order = [1 3 2];
% Parameters = {b_sim*2; c2_sim; m2_sim*2; J2_sim*2; g_sim};
Parameters = { 0.1, 0.07};
InitialStates = [theta_2(1);0];
Ts = 0;
nlgr = idnlgrey(fileName,order,Parameters,InitialStates,Ts, ...
    'Name','Single Pendulum');

nlgr.Parameters(1).Minimum = 0;
nlgr.Parameters(2).Minimum = 0;

opt = nlgreyestOptions('Display', 'On');
nlgr = nlgreyest(z,nlgr,opt);

figure()
compare(z,nlgr,Inf)